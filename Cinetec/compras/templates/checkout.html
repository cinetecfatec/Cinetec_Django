{% extends 'index.html' %}
{% load static %}

{% block titulo %}
<title>Checkout</title>
<link rel="stylesheet" href="{% static 'css/Checkout.css' %}">
{% endblock %}

{% block conteudo %}
<div class="ingressos">
{% for assento in dados.assentos_escolhidos %}
    {% for filme in dados.filmes %}
    <div class="ingresso">
        <div class="info">Sala {{ filme.sala }}</div>
        <div class="info">{{ filme.nome }}</div>
        <div class="info">Sessão: {{ filme.pk }}</div>
        <div class="info">Cadeira: {{ assento }}</div>
        <div class="info">
            Tipo do ingresso:
            <select name="tipo-ingresso" id="ingresso-{{ assento }}" onchange="atualizarPrecoIngresso('{{ assento }}', {{ filme.pk }})">
                <option value="inteira" data-preco="{{dados.inteira}}" selected>Inteira</option>
                <option value="meia" data-preco="{{dados.meia}}">Meia</option>
                <option value="vip" data-preco="{{dados.vip}}">Vip</option>
            </select>
        </div>
        <div class="info">Preço: <p id="preco-{{ assento }}">R$25,00</p></div>
    </div>
    {% endfor %}
{% endfor %}

<div class="bomboniere">
    <div class="title">BOMBONIERE</div>
    <div class="bomboniereContent">
        <div class="comida">
            {% for x in dados.preco %}
                {% if x.tipo == 'pipoca' %}
            <div class="comidacontent" onclick="click('{{x.id_produto}}')">
                <img src="{% static 'img/pipoca.png' %}" alt="">
                <p>{{x.descricao}}</p>
                <p>R${{x.preco}}</p>
                <input type="text" value="0" min="0" onchange="preco('{{x.id_produto}}')" id="{{x.id_produto}}" readonly>
                <div class="botoes">
                    <input type="button" value="-" onclick="menos('{{x.id_produto}}', -{{x.preco}})" class="menos">
                    <input type="button" value="+" onclick="mais('{{x.id_produto}}', {{x.preco}})" class="mais">
                </div>
            </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="comida">
            {% for x in dados.preco %}
                {% if x.tipo == 'refrigerante' %}
            <div class="comidacontent">
                <img src="{% static 'img/refrigerantes.png' %}" alt="">
                <p>{{x.descricao}}</p>
                <p>R${{x.preco}}</p>
                <input type="text" value="0" min="0" onchange="preco('{{x.id_produto}}')" id="{{x.id_produto}}" readonly>
                <div class="botoes">
                    <input type="button" value="-" onclick="menos('{{x.id_produto}}', -{{x.preco}})" class="menos">
                    <input type="button" value="+" onclick="mais('{{x.id_produto}}', {{x.preco}})" class="mais">
                </div>
            </div>
                {% endif %}
            {% endfor %}
        </div>
        <div class="comida">
            {% for x in dados.preco %}
                {% if x.tipo == 'chocolate' %}
            <div class="comidacontent">
                <img src="{% static 'img/chocolate.png' %}" alt="">
                <p>{{x.descricao}}</p>
                <p>R${{x.preco}}</p>
                <input type="text" value="0" min="0" onchange="preco('{{x.id_produto}}')" id="{{x.id_produto}}" readonly>
                <div class="botoes">
                    <input type="button" value="-" onclick="menos('{{x.id_produto}}', -{{x.preco}})" class="menos">
                    <input type="button" value="+" onclick="mais('{{x.id_produto}}', {{x.preco}})" class="mais">
                </div>
            </div>
                {% endif %}
            {% endfor %}

        </div>
    </div>
</div>

<div class="compra">
    <input type="button" value="COMPRAR">
    <div class="preco">
        Preço total: <p id="precototal">R$0,00</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    var y = 0;

    function menos(i, x) {
        let z = document.getElementById(i).value;
        if (parseInt(z) <= 0) {
            return;
        }
        document.getElementById(i).value = parseInt(z) - 1;
        atualizarPrecoTotal(x);
    }

    function mais(i, x) {
        let z = document.getElementById(i).value;
        document.getElementById(i).value = parseInt(z) + 1;
        atualizarPrecoTotal(x);
    }

    function atualizarPrecoTotal(x) {
        y += parseFloat(x);
        document.getElementById('precototal').innerText = 'R$' + y.toFixed(2);
    }

    function atualizarPrecoIngresso(assento, sessao) {
        const select = document.getElementById('ingresso-' + assento);
        const preco = select.options[select.selectedIndex].getAttribute('data-preco');
        document.getElementById('preco-' + assento).innerText = 'R$' + parseFloat(preco).toFixed(2);

        recalcularPrecoTotal();
    }

    function preco(i, x) {
        y += parseFloat(x);
        document.getElementById('precototal').innerText = 'R$' + y.toFixed(2);
    }

    function inicializarPrecoTotal() {
        let totalIngresso = 0;
        document.querySelectorAll("select[name='tipo-ingresso']").forEach((element) => {
            const precoInicial = element.options[element.selectedIndex].getAttribute('data-preco');
            totalIngresso += parseFloat(precoInicial);
        });

        let totalBomboniere = 0;
        document.querySelectorAll("input[type='text']").forEach((element) => {
            const valor = parseInt(element.value) || 0;
            const precoProduto = parseFloat(element.closest('.comidacontent').querySelector('p:nth-child(3)').innerText.replace('R$', '').replace(',', '.'));
            totalBomboniere += valor * precoProduto;
        });

        y = totalIngresso + totalBomboniere;
        document.getElementById('precototal').innerText = 'R$' + y.toFixed(2);
    }

    function recalcularPrecoTotal() {
        let totalIngresso = 0;
        document.querySelectorAll("select[name='tipo-ingresso']").forEach((element) => {
            const precoSelecionado = element.options[element.selectedIndex].getAttribute('data-preco');
            totalIngresso += parseFloat(precoSelecionado);
        });

        let totalBomboniere = 0;
        document.querySelectorAll("input[type='text']").forEach((element) => {
            const valor = parseInt(element.value) || 0;
            const precoProduto = parseFloat(element.closest('.comidacontent').querySelector('p:nth-child(3)').innerText.replace('R$', '').replace(',', '.'));
            totalBomboniere += valor * precoProduto;
        });

        y = totalIngresso + totalBomboniere;
        document.getElementById('precototal').innerText = 'R$' + y.toFixed(2);
    }

    document.addEventListener("DOMContentLoaded", inicializarPrecoTotal);
</script>
{% endblock %}
